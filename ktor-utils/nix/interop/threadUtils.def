---
#include <execinfo.h>
#include <signal.h>
#include <stdatomic.h>

void* callstack[256];
int stack_size;

#define STARTED 1
#define DONE 0
_Atomic int state;


void start_operation() {
    atomic_store(&state, STARTED);
}

void finish_operation() {
    atomic_store(&state, DONE);
}

int is_done() {
    return atomic_load(&state);
}

void dump_backtrace(int signum) {
    stack_size = backtrace(callstack, 256);
    finish_operation();
}

void set_signal_handler() {
    atomic_init(&state, DONE);
    signal(SIGUSR2, dump_backtrace);
}
